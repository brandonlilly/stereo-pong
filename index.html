<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pong</title>

</head>
<body>
  <canvas id="pong-canvas" style="border: 1px solid black; margin: 200px auto; display: block"></canvas>

  <script src="AutoStereogram.js"></script>
  <script src="pong.js"></script>
  <script src="keymaster.js"></script>

  <script>
    var canvas = document.getElementById("pong-canvas");
    var ctx = canvas.getContext("2d");
    width = 800;
    height = 400;
    canvas.width = width;
    canvas.height = height;
    var game = new Pong(ctx, width, height);

    depthMap = [];
    for (var y = 0; y < height; y++) {
      depthMap[y] = [];
      for (var x = 0; x < width; x++) {
        depthMap[y][x] = 0;
      }
    }

    var colors = [
      [71, 113, 134],
      [110, 146, 161],
      [17, 60, 81],
      [3, 37, 54],
      [54, 130, 127],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
      [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)],
    ];

    var canvasData = ctx.getImageData(0, 0, width, height);

    // That's how you define the value of a pixel //
    function drawPixel (x, y, r, g, b, a) {
        var index = (x + y * width) * 4;

        canvasData.data[index + 0] = r;
        canvasData.data[index + 1] = g;
        canvasData.data[index + 2] = b;
        canvasData.data[index + 3] = a;
    }

    function updateCanvas() {
        ctx.putImageData(canvasData, 0, 0);
    }

    function drawCanvas(ctx, pixels, colors) {
      for (var y = 0; y < pixels.length; y++) {
        for (var x = 0; x < pixels[0].length; x++) {
          var color = colors[pixels[y][x]];
          // data.push(color[0], color[1], color[2], 255);
          // data = data.concat(color, 255);
          // canvasData.data[index + 0] = r;
          // canvasData.data[index + 1] = g;
          // canvasData.data[index + 2] = b;
          // canvasData.data[index + 3] = a;
          drawPixel(x, y, color[0], color[1], color[2], 255);
        }
      }

      // var imageData = ctx.createImageData(width, height);
      // imageData.data.set(data);
      ctx.putImageData(canvasData, 0, 0);
    }



    var t = 0;
    var mapFunction = function(x, y) {
      var offset = Math.cos(t * 0.2) * 100;
      if (x > 370 && x < 430 && y > 150 + offset && y < 200 + offset) {
        return true;
      }
      return false;
    };

    var square = function(w, h, xPos, yPos) {
      return function(x, y) {
        return (x < xPos + w/2 && x > xPos - w/2 && y < yPos + h/2 && y > yPos - h/2);
      };
    }

    var circle = function(r, xPos, yPos) {
      var xPos = 350;
      var yPos = 180 + Math.cos(t * 0.1) * 100;
      return function(x, y) {
        return (Math.sqrt(Math.pow(x - xPos, 2) + Math.pow(y - yPos, 2)) < r);
      };
    }

    var basePixels = AutoStereogram.generatePixels(
      depthMap,
      {
        width: width,
        height: height,
        mu: (1/3),
        dpi: 72,
      }
    );

    leftPaddle = {
      x: 150,
      y: 50,
    }

    document.onkeydown = function(e) {
      switch (e.keyCode) {
        case 87:
          leftPaddle.y -= 20;
          break;
        case 83:
          leftPaddle.y += 20;
          break;
        default:
          console.log(e.keyCode);
      }
    };

    var generateBase = function() {
      return AutoStereogram.generatePixels(
        depthMap,
        {
          width: width,
          height: height,
          mu: (1/3),
          dpi: 72,
        }
      );
    }

    basePixels = generateBase();

    bases = [];
    for(var i = 0; i < 3; i++) {
      bases.push(generateBase());
    }

    var interval = setInterval(function() {
      t += 1;

      // lastRow = basePixels.pop(5);
      // basePixels.unshift(lastRow);

      // if (t % 10 === 0) {
        basePixels = generateBase();
      // }
      paddle = square(35, 90, leftPaddle.x, leftPaddle.y);
      var c = circle(30);

      var pixels = AutoStereogram.drawSurface(
        bases[t % 3],
        // basePixels,
        function(x, y) {
          return c(x, y) || paddle(x, y);
        },
        {
          width: width,
          height: height,
          mu: (1/3),
          dpi: 72,
          depth: 0.7,
        }
      );

      var pixels = AutoStereogram.drawSurface(
        // basePixels[t % 20],
        pixels,
        function(x, y) {
          return square(100, 400, 50, 200)(x, y) || square(100, 400, 750, 200)(x, y);
        },
        {
          width: width,
          height: height,
          mu: (1/3),
          dpi: 72,
          depth: 1,
        }
      );

      drawCanvas(ctx, pixels, colors);
  }, 100);

  // setTimeout(function() {
  //   clearInterval(interval);
  // }, 0);

  </script>
</body>
</html>
